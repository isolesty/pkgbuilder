#! /bin/bash

set -e

declare -r scriptdir=$(dirname $(readlink -ef $0))

declare -ra modules=(
    conf/{env,dde}
    lib/{common,utils,modules}
)

##########
# Real operation starts
##############################
for module in ${modules[@]}; do
    source ${scriptdir}/$module
done

[[ $EUID -eq 0 ]] && warn "You should build package with an unpriviledged user"

OPTS=$(getopt -n $0 \
        -o 'a:c:d:l:n:t:u:bhpv' \
        --long arch:,cl:,dsc:,changelog:,package:,target-branch:,upload:,build,help,pbuilder,version \
        -- "$@")

[[ $? -eq 0 ]] || die "Sorry! I don't understand!!!"

eval set -- "${OPTS}"

while : ; do
    case $1 in
        -a|--arch)
            ARCH=$2
            shift 2
            ;;
        -c|--cl)
            CHANGELIST=$2
            [[ $CHANGELIST -eq 0 ]] && die "CL $CHANGELIST is illegal"
            shift 2
            ;;
        -d|--dsc)
            dscurl=$2
            shift 2
            ;;
        -l|--changelog)
            changelog=$2
            shift 2
            ;;
        -n|--package)
            package=$2
            shift 2
            ;;
        -t|--target-branch)
            targetbranch=$2
            shift 2
            ;;
        -u|--upload)
            uhost=$2
            shift 2
            ;;
        -b|--build)
            do_build=1
            shift
            ;;
        -p|--pbuilder)
            usepbuilder=1
            do_build=1
            shift
            ;;
        -h|--help)
            printHelp
            shift
            ;;
        -v|--version)
            printVersion
            shift
            ;;
        --)
            shift
            break
            ;;
        *)
            printHelp
            shift
            ;;
    esac
done

[[ -n ${ARCHITECTURES[$ARCH]} ]] || die "$ARCH is an unsupported architecture"

source ${scriptdir}/conf/cowbuilder

# set default changelog
[[ -z $changelog ]] && changelog="Rebuild on ${ARCH}"

# set git repository for dde components
if [[ -n ${package} ]] ; then
    createdir $REPOBASE

    case ${package} in
        lastore-daemon*)
            repository=${BASEURI}/lastore/${package}
            ;;
        deepin-default-settings)
            repository=${BASEURI}/${package##deepin-}
            ;;
        *)
            repository=${BASEURI}/${package}
            ;;
    esac

    if [[ -n ${DDE_COMPONENTS[$package]} ]]; then
        repository=${BASEURI}/dde/${package}
    fi
fi

if [[ -n ${dscurl} ]] ;then
    downloadDebianSrc
else
    createSrcArchives
fi
printBuildInfo
prepareBuild
createPbuilderChroot
buildPackage $@
uploadArtifacts

# vim: number tabstop=4 softtabstop=4 expandtab
