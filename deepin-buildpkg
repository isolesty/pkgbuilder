#! /bin/bash

set -e

declare -r scriptdir=$(dirname $(readlink -ef $0))

declare -ra modules=(
    conf/{env,dde}
    lib/{common,utils,modules}
)

printHelp() {
    cat <<EOF >&2
Usage:
  $0 -n PACKAGE|-d DSC [-a ARCH] [-c NUMBER] [-l CHANGELOG] [-t BRANCH] [-u HOST] [-w WORKDIR] [-b|-p] [-h] [-v]

Package builder for deepin mips team

Help Options:
  -h, --help            Show help options
Application Options:
  -a, --arch=ARCH              Build package for ARCH architecture
  -c, --cl=NUMBER              Build package based on a CL: NUMBER
  -d, --dsc=DSC                Build package according to a DSC, DSC should be
                               a local path or url to Debian src control file
  -l, --changelog=CHANGELOG    Use CHANGELOG as debian package changelog
  -n, --package=PACKAGE        Build PACKAGE
  -t, --target-branch=BRANCH   Check out to specific BRANCH
  -u, --upload=HOST            Upload build artifacts to HOST, you should
                               define HOST in dput config
  -b, --build                  Perform a package build using debuild
  -p, --pbuilder               Perform a package build using pbuilder
                               (recommended for a clean buid)
  -v, --version                Show version

Note:
$0 will not issue any build command (pdebuild or debuild) unless -p or -b option is specified.

Examples:
  $0 -n dde-desktop                            Prepare for building dde-destop
  $0 -n dde-desktop -c 64380 -p                Build dde-desktop with gerrit change 64380
                                               in a pbuilder chroot
  $0 -n dde-desktop -b                         Build dde-desktop from scratch
  $0 -n dde-desktop -b -u staging              Build dde-desktop then upload to staging
  $0 -n dde-api -p -l "Rebuild for testing"    Build dde-api in a clean pbuilder chroot
  $0 -a mips64el -n base-files -p              Build base-files in a clean mips64el chroot
EOF
    exit 0
}

##########
# Real operation starts
##############################
for module in ${modules[@]}; do
    source ${scriptdir}/$module
done

[[ $EUID -eq 0 ]] && warn "You should build package with an unpriviledged user"

OPTS=$(getopt -n $0 \
        -o 'a:c:d:l:n:t:u:bhpv' \
        --long arch:,cl:,dsc:,changelog:,package:,target-branch:,upload:,build,help,pbuilder,version \
        -- "$@")

[[ $? -eq 0 ]] || die "Sorry! I don't understand!!!"

eval set -- "${OPTS}"

while : ; do
    case $1 in
        -a|--arch)
            ARCH=$2
            shift 2
            ;;
        -c|--cl)
            CHANGELIST=$2
            [[ $CHANGELIST -eq 0 ]] && die "CL $CHANGELIST is illegal"
            shift 2
            ;;
        -d|--dsc)
            dscurl=$2
            shift 2
            ;;
        -l|--changelog)
            changelog=$2
            shift 2
            ;;
        -n|--package)
            package=$2
            shift 2
            ;;
        -t|--target-branch)
            targetbranch=$2
            shift 2
            ;;
        -u|--upload)
            uhost=$2
            shift 2
            ;;
        -b|--build)
            do_build=1
            shift
            ;;
        -p|--pbuilder)
            usepbuilder=1
            do_build=1
            shift
            ;;
        -h|--help)
            printHelp
            shift
            ;;
        -v|--version)
            printVersion
            shift
            ;;
        --)
            shift
            break
            ;;
        *)
            printHelp
            shift
            ;;
    esac
done

[[ -n ${ARCHITECTURES[$ARCH]} ]] || die "$ARCH is an unsupported architecture"

source ${scriptdir}/conf/cowbuilder

# set default changelog
[[ -z $changelog ]] && changelog="Rebuild on ${ARCH}"

# set git repository for dde components
if [[ -n ${package} ]] ; then
    createdir $REPOBASE

    case ${package} in
        lastore-daemon*)
            repository=${BASEURI}/lastore/${package}
            ;;
        deepin-default-settings)
            repository=${BASEURI}/${package##deepin-}
            ;;
        *)
            repository=${BASEURI}/${package}
            ;;
    esac

    if [[ -n ${DDE_COMPONENTS[$package]} ]]; then
        repository=${BASEURI}/dde/${package}
    fi
fi

if [[ -n ${dscurl} ]] ;then
    downloadDebianSrc
else
    createSrcArchives
fi
printBuildInfo
prepareBuild
createPbuilderChroot
buildPackage $@
uploadArtifacts

# vim: number tabstop=4 softtabstop=4 expandtab
